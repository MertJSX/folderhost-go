name: Create Release

on:
  workflow_dispatch:
    inputs:
      release_type:
        description: 'Release type'
        required: true
        type: choice
        options:
        - major    # v25.1.0 â†’ v25.2.0
        - minor    # v25.1.0 â†’ v25.1.1
        - auto
      custom_version:
        description: 'Custom version (optional)'
        required: false
        type: string

env:
  BINARY_NAME: folderhost

jobs:
  build-and-release:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Calculate automatic version
      id: version
      run: |
        echo "Full date: $(date)"
        echo "Year (full): $(date +'%Y')"
        echo "Year (short): $(date +'%y')" 
        echo "Month: $(date +'%m')"
        echo "Day: $(date +'%d')"
        
        CURRENT_YEAR=$(date +'%y')
        CURRENT_MONTH=$(date +'%m')
        
        echo "Using Year: $CURRENT_YEAR, Month: $CURRENT_MONTH"
        
        if [[ "${{ github.event.inputs.release_type }}" == "auto" ]]; then
          LATEST_TAG=$(git tag -l "v$CURRENT_YEAR.$CURRENT_MONTH.*" --sort=-v:refname | head -n 1)
          
          if [ -z "$LATEST_TAG" ]; then
            VERSION="v$CURRENT_YEAR.$CURRENT_MONTH.0"
          else
            LAST_PATCH=$(echo $LATEST_TAG | awk -F. '{print $3}')
            NEW_PATCH=$((LAST_PATCH + 1))
            VERSION="v$CURRENT_YEAR.$CURRENT_MONTH.$NEW_PATCH"
          fi
          
        elif [[ "${{ github.event.inputs.release_type }}" == "major" ]]; then
          VERSION="v$CURRENT_YEAR.$((CURRENT_MONTH)).0"
          
        elif [[ "${{ github.event.inputs.release_type }}" == "minor" ]]; then
          LATEST_TAG=$(git describe --tags --abbrev=0 2>/dev/null || echo "v$CURRENT_YEAR.$CURRENT_MONTH.0")
          LAST_PATCH=$(echo $LATEST_TAG | awk -F. '{print $3}')
          VERSION="v$CURRENT_YEAR.$CURRENT_MONTH.$((LAST_PATCH + 1))"
          
        else
          VERSION="${{ github.event.inputs.custom_version }}"
        fi

        echo "version=$VERSION" >> $GITHUB_OUTPUT
        echo "ðŸŽ¯ Calculated version: $VERSION"

    - name: Get current date
      id: date
      run: echo "current_date=$(date +'%Y-%m-%d %H:%M:%S')" >> $GITHUB_OUTPUT

    - name: Setup Go
      uses: actions/setup-go@v4
      with:
        go-version: '1.21'

    - name: Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '18'

    - name: Install Mingw for Windows cross-compilation
      run: |
        sudo apt-get update
        sudo apt-get install -y gcc-mingw-w64

    - name: Install dependencies
      run: |
        make setup

    - name: Build for Linux and Windows
      run: |
        make build

    - name: Create Linux package
      run: |
        mkdir -p ./release_packages
        cp ./debug/${{ env.BINARY_NAME }} ./${{ env.BINARY_NAME }}
        chmod +x ./${{ env.BINARY_NAME }}
        zip -j ./release_packages/folderhost-linux-amd64.zip ./${{ env.BINARY_NAME }}
        rm ./${{ env.BINARY_NAME }}
        echo "ðŸ“¦ Linux package created"

    - name: Create Windows package
      run: |
        cp ./debug/${{ env.BINARY_NAME }}.exe ./${{ env.BINARY_NAME }}.exe
        zip -j ./release_packages/folderhost-windows-amd64.zip ./${{ env.BINARY_NAME }}.exe
        rm ./${{ env.BINARY_NAME }}.exe
        echo "ðŸ“¦ Windows package created"

    - name: List release packages
      run: ls -la ./release_packages/

    - name: Create Release
      uses: softprops/action-gh-release@v1
      with:
        tag_name: ${{ steps.version.outputs.version }}
        name: Release ${{ steps.version.outputs.version }}
        body: |
          ðŸš€ Automatic Build Release
          Version: ${{ steps.version.outputs.version }}
          Date: ${{ steps.date.outputs.current_date }}
          
          ## ðŸ“¦ Download Packages
          
          - **Linux**: [folderhost-linux-amd64.zip](folderhost-linux-amd64.zip) - Linux x86_64 binary
          - **Windows**: [folderhost-windows-amd64.zip](folderhost-windows-amd64.zip) - Windows x86_64 executable
          
          ## ðŸ”§ Installation
          
          1. Download the zip file for your operating system
          2. Extract the binary
          3. Place the binary into folder
          4. Run the application
          5. Configure the config.yml file
          6. Restart the application
        files: |
          ./release_packages/folderhost-linux-amd64.zip
          ./release_packages/folderhost-windows-amd64.zip
        draft: false
        prerelease: false
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}